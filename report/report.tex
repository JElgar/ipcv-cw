% Preamble
% ---
\documentclass{article}

% Packages

\usepackage{graphicx}
\usepackage{subfig}
\usepackage{pgfplots}

\usepackage{multicol}
\usepackage{float}

\usepackage{tikz}
\usetikzlibrary{shapes.geometric, arrows}

\usepackage{geometry}
\geometry{margin=0.5in}

% ---


\graphicspath{ {assets/} }
\begin{document}


\section{Face detection}

\begin{multicols}{2}

TOGO
Limitation of TPR. Difficult to define "true" values. The bouding region of a
face is discrete and we may choose not to detect side on faces. Example below
shows 2 possible "true" values for a detection. One give a IOU of under 0.7 but
the other gives over 0.9.

% -- Part 1 - Image section
\begin{multicols}{2}
  \centerline{\includegraphics[width=\linewidth]{dart4-face.jpg}\par}
  \centerline{\includegraphics[width=\linewidth]{dart5-face.jpg}\par}
  \centerline{\includegraphics[width=\linewidth]{dart13-face.jpg}\par}
  \centerline{\includegraphics[width=\linewidth]{dart14-face.jpg}\par}
  \centerline{\includegraphics[width=\linewidth]{dart15-face.jpg}\par}
\end{multicols}
\captionof{figure}{Viola-Jones face detection (green) with ground truth (red)}
\label{fig:vjface}


\begin{tabular}{ |p{2cm}||p{2cm}|p{2cm}| }
 \hline
 \multicolumn{3}{|c|}{Frontal face detection results} \\
 \hline
 Image name & TPR & F1-SCORE \\
 \hline
 dart4  & 1   & 1         \\
 dart5  & 1   & 0.88      \\
 dart13 & 1   & 0.666667  \\ 
 dart14 & 1   & 0.5       \\ 
 dart15 & 1   & 0         \\ 
 \hline
\end{tabular}

\bigskip

The results show that the true positivity rate, TPR, for all images is 1.
Despite this we often see far lower F1 scores. This reveals the limitation of
the TPR as a detector can always achieve a high TPR by having a low tolerance
to classify something as a face. This would result in a very low F1 score as
many false positives would arise yet the true positivity rate would remain
high.

The image dart-15 reveals another limitation of these metrics. It can often to
difficult to classify the ground truth. This classifier was created to detect
frontal faces and therefore in dart15 I have claimed no frontal face present.
Despite this the classifier has detected on of the faces brining its F1 score
down. Similarly there is no clear boundry for a face and therefore the exact
area that should be detected can vary resulting in the need for a larger
tolerance for the intersection over area, IOU.

\section{Dart board detection}

\begin{multicols}{2}

  \resizebox{\columnwidth}{!}{
  
    \begin{tikzpicture}
    \begin{axis}[
        title={TPR vs FPR throughout training},
        xlabel={FPR},
        ylabel={TPR},
        xmin=0, xmax=1,
        ymin=0, ymax=1,
        xtick={0, 0.2, 0.4, 0.6, 0.8, 1.0 },
        ytick={0, 0.2, 0.4, 0.6, 0.8, 1.0 },
        legend pos=north west,
        ymajorgrids=true,
        grid style=dashed,
    ]
  
    \addplot[
        color=red,
        mark=*,
        ]
        coordinates {
          (1,1)(0.0163415,1)(0.000237497,1)
        };
        
    \end{axis}
    \end{tikzpicture}
  }
 

  \resizebox{\columnwidth}{!}{
  
    \begin{tikzpicture}
    \begin{axis}[
        title={TPR and FPR vs training step},
        xlabel={Stage},
        ylabel={Value},
        xmin=0.8, xmax=3.2,
        ymin=-0.05, ymax=1.05,
        xtick={1, 2, 3},
        ytick={0, 0.2, 0.4, 0.6, 0.8, 1.0 },
        legend style={at={(0.97,0.5)},anchor=east},
        ymajorgrids=true,
        grid style=dashed,
    ]
    
    \addplot[
        color=red,
        mark=*,
        ]
        coordinates {
          (1,1)(2, 0.0163415)(3, 0.000237497)
        };
    \addlegendentry{FPR}
    
    \addplot[
        color=blue,
        mark=*,
        ]
        coordinates {
          (1,1)(2,1)(3,1)
        };
    \addlegendentry{TPR}
        
    \end{axis}
    \end{tikzpicture}

  }
\end{multicols}{2}

Figure \ref{tprvsfprtraining} shows the change in FPR and TPR throughout the
training process. At the beginning of the training all images are accepted
throughout the stages more layers are added to the cascade. Each layer will
remove of the regions classified as a dart board. This results in a drop in FPR
as the training takes place. Throughout the training process the TPR remains
and 1. However if more layers were added (and therefore the classifier removed
more classified regions) then the TPR could also be reduced. This could still
result in the classifiers F1 score increasing as the FPR would also be
decreasing.

\begin{multicols}{3}
    \includegraphics[width=\linewidth]{dart1-dart.jpg}\par
    \includegraphics[width=\linewidth]{dart6-dart.jpg}\par
    \includegraphics[width=\linewidth]{dart4-dart.jpg}\par
\end{multicols}
\captionof{figure}{Viola-Jones dartboard detection with true values}
\label{tab:vjdartsimages}


\begin{tabular}{ |p{2cm}||p{2cm}|p{2cm}| }
 \hline
 \multicolumn{3}{|c|}{Frontal face detection results} \\
 \hline
 Image name & TPR & F1-SCORE \\
 \hline
 dart1  & 1  & 0.666667   \\
 dart2  & 1  & 0.25       \\
 dart3  & 1  & 0.4        \\
 dart4  & 0  & 0          \\
 dart5  & 0  & 0          \\
 dart6  & 1  & 0.181818   \\
 dart7  & 0  & 0          \\
 dart8  & 0  & 0          \\
 dart9  & 0  & 0          \\
 dart10 & 0  & 0          \\
 dart11 & 0  & 0          \\
 dart12 & 0  & 0          \\
 dart13 & 0  & 0          \\
 dart14 & 0  & 0          \\
 dart15 & 1  & 0.5        \\
 \hline
 Average& 0.333333  & 0.133232    \\ 
 \hline
\end{tabular}
\captionof{table}{Viola-Jones face detection (green) with ground truth (red)}
\label{tab:vjdartstable}


The average values in Table \ref{tab:vjdartstable}, show the unreliable results of
the cascade for detecting dart boards.  It not only has a very low TPR and also
a very low F1-score suggesting there are many missed dart boards as well as
regions falsely classified. The images in Figure \ref{tab:vjdartsimages} show
the wide range of results from the classifier. a and b show successful
classifications yet b and c show the high number of false positives. It is also
noteworthy that the TPR values achieved during training were far higher than
the average achieved during testing. This is as a result of the method used to
generate positive images. These took one image of a dart board and generated
variations (via movements/rotations) on that image. This means when classifying
different types of dartboards of those with objects in the way (such as
\ref{tab:vjdartsimages} c) the classifier performs far worse.

\section{Combining Viola-Jones with hough circle detection}

From the above section it is clear that the Viola Jones detector is not well
suited to detecting dart boards and especially not to detecting the circular
shape of the dart board. In order to overcome this limitation the results from
the Viola-Jones detector can be combined with a circle hough transform. This
circle hough transform can then be used to shrink the results set and increase
the F1 score of the detector. The combination step is as follows:

\begin{itemize}
  \item Run Viola-Jones and hough circles.
  \item For every Viola-Jones results find the maximum IOU with the circles
    from hough. 
  \item If the IOU is greater than a specified threshold (0.4 in this case)
    add results from the hough to the set of final results. 
\end{itemize} 

The use of IOU with hough resulted in a large reduction in the set of results.
For the required IOU a relatively low threshold was chosen (0.4) as often the
Viola-Jones detector would find a section of the dart board (matching the
expected pattern) but no the circle. For this reason the final result used the
bounding box from the hough circle rather than the Viola-Jones detector as this
was more likely to encompass the full dartboard. This removed many of the
original Viola-Jones false positives and therefore increased the F1-score
dramatically.  However the limitation of this approach are clear in
\ref{vjhough} which shows the circle detector failing to detect circles with
large angles to the camera or with objects blocking sections of the circle.
This can result in a reduction in the TPR rate of the overall detector in
exchange for the reduction in the number of false positives.

\begin{multicols}{4}
  \centerline{\includegraphics[width=\linewidth]{houghvj/8/gradmag.png}\par}
  \centerline{\includegraphics[width=\linewidth]{houghvj/8/graddirection.png}\par}
  \centerline{\includegraphics[width=\linewidth]{houghvj/8/cirlce-hough-space.jpg}\par}
  \centerline{\includegraphics[width=\linewidth]{houghvj/8/final-output.jpg}\par}
\end{multicols}
\captionof{figure}{Hough circle detection on dart8.jpg}
\label{fig:hough1results}

\begin{multicols}{4}
  \centerline{\includegraphics[width=\linewidth]{houghvj/8/gradmag.png}\par}
  \centerline{\includegraphics[width=\linewidth]{houghvj/8/graddirection.png}\par}
  \centerline{\includegraphics[width=\linewidth]{houghvj/8/cirlce-hough-space.jpg}\par}
  \centerline{\includegraphics[width=\linewidth]{houghvj/8/final-output.jpg}\par}
\end{multicols}
\captionof{figure}{Hough circle detection on dart8.jpg}
\label{fig:hough2results}

\begin{tabular}{ |p{1.3cm}||p{1.3cm}|p{1.3cm}|p{1.3cm}|p{1.3cm}| }
 \hline
 \multicolumn{5}{|c|}{Frontal face detection results} \\
 \hline
 Image name & TPR & F1 & \(\Delta\) TPR & \(\Delta\) F1 \\
 \hline
 dart1  & 1  & 1 \\
 dart2  & 1  & 0.5       \\
 dart3  & 1  & 0.5        \\
 dart4  & 0  & 0          \\
 dart5  & 1  & 1          \\
 dart6  & 0  & 0 \\
 dart7  & 1  & 0.5          \\
 dart8  & 0.5  & 0.666667          \\
 dart9  & 0  & 0          \\
 dart10 & 0  & 0          \\
 dart11 & 0.333333  & 0.5          \\
 dart12 & 0  & 0          \\
 dart13 & 1  & 0.4          \\
 dart14 & 1  & 0.5          \\
 dart15 & 1  & 1        \\
 \hline
 Average& 0.333333  & 0.133232    \\ 
 \hline
\end{tabular}
\captionof{table}{Viola-Jones face detection (green) with ground truth (red)}
\label{tab:vjdartstable}


\begin{tikzpicture}[node distance=1cm]
\tikzstyle{line}=[draw]
\tikzstyle{process} = [rectangle, minimum width=3cm, minimum height=1cm, text centered, text width=3cm, draw=black, fill=orange!30]
\tikzstyle{decision} = [diamond, minimum width=3cm, text centered, text width=3cm, draw=black, fill=green!30]
\tikzstyle{sdecision} = [diamond, minimum width=3cm, draw=black, fill=green!30]
\tikzstyle{arrow}=[draw, -latex]

\node (start) [sdecision, yshift=-0.5cm] {Start};
\node (gray) [process, below of=start, yshift=-0.5cm] {Gray image};
\node (eqHist) [process, below of=gray, yshift=-0.5cm] {Equalize histogram};
\node (grad) [process, below right of=eqHist, yshift=-0.8cm, xshift=1.5cm] {Image gradient};
\node (hough) [process, below of=grad, yshift=-0.5cm] {Hough circle transform};
\node (vj) [process, below left of=eqHist, yshift=-0.8cm, xshift=-1.cm] {Vila Jones detection};
\node (threshold) [decision, below left of=hough, yshift=-2.5cm, xshift=-1.cm] {Compare intersection of hough and viloajones};

\draw [arrow] (start) -- (gray);
\draw [arrow] (gray) -- (eqHist);
\draw [arrow] (eqHist) -| (grad);
\draw [arrow] (eqHist) -| (vj);
\draw [arrow] (grad) -- (hough);

\draw [arrow] (hough) -- (threshold);
\draw [arrow] (vj) -- (threshold);

\end{tikzpicture}



\end{multicols}{2}
\end{document}
